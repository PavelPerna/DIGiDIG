services:

  services:
    build:
      context: .
      dockerfile: ./services/services/Dockerfile
    image: ghcr.io/pavelperna/digidig-services:latest
    restart: unless-stopped
    ports:
      - "${SERVICES_HTTP_PORT:-9120}:9120"   # HTTP
      - "${SERVICES_HTTPS_PORT:-9220}:9220"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - SERVICES_HTTP_PORT=9120
      - SERVICES_HTTPS_PORT=9220
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
      - smtp
      - imap
      - storage
      - admin
      - client
      - test-suite
      - mail
      - apidocs
      - sso
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:9120/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASS:-securepassword}
      - POSTGRES_DB=${DB_NAME:-strategos}
    ports:
      - "${POSTGRES_PORT:-5432}:${POSTGRES_PORT:-5432}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - strategos-net
    volumes:
      - postgres_data:/var/lib/postgresql/data

  mongo:
    image: mongo:6
    restart: unless-stopped
    environment:
      - MONGO_INITDB_DATABASE=strategos
    ports:
      - "${MONGO_PORT:-27017}:${MONGO_PORT:-27017}"
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand('ping').ok"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - strategos-net
    volumes:
      - mongo_data:/data/db

  identity:
    build:
      context: .
      dockerfile: ./services/identity/Dockerfile
    image: ghcr.io/pavelperna/digidig-identity:latest
    restart: unless-stopped
    ports:
      - "${IDENTITY_HTTP_PORT:-9101}:9101"   # HTTP
      - "${IDENTITY_HTTPS_PORT:-9201}:9201"  # HTTPS
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - IDENTITY_HTTP_PORT=9101
      - IDENTITY_HTTPS_PORT=9201
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
      # Database connection settings (forwarded from top-level .env)
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASS=${DB_PASS:-securepassword}
      - DB_NAME=${DB_NAME:-strategos}
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - identity_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${IDENTITY_PORT:-9101}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  smtp:
    build:
      context: .
      dockerfile: ./services/smtp/Dockerfile
    image: ghcr.io/pavelperna/digidig-smtp:latest
    restart: unless-stopped
    ports:
      - "${SMTP_REST_PORT:-9100}:${SMTP_REST_PORT:-9100}"   # FastAPI REST API
      - "${SMTP_SMTP_PORT:-25}:${SMTP_SMTP_PORT:-25}"       # SMTP (RFC 5321)
      - "${SMTP_SMTPS_PORT:-465}:${SMTP_SMTPS_PORT:-465}"   # SMTPS (RFC 8314)
      - "${SMTP_SUBMISSION_PORT:-587}:${SMTP_SUBMISSION_PORT:-587}" # SMTP Submission (RFC 6409)
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - smtp_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${SMTP_REST_PORT:-9100}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  imap:
    build:
      context: .
      dockerfile: ./services/imap/Dockerfile
    image: ghcr.io/pavelperna/digidig-imap:latest
    restart: unless-stopped
    ports:
      # REST API port for the IMAP service (used by health, admin, UI)
      - "${IMAP_REST_PORT:-9103}:${IMAP_REST_PORT:-9103}"
      # IMAP protocol ports (RFC 3501)
      - "${IMAP_PROTOCOL_PORT:-143}:${IMAP_PROTOCOL_PORT:-143}"     # IMAP (cleartext)
      - "${IMAP_S_PROTOCOL_PORT:-993}:${IMAP_S_PROTOCOL_PORT:-993}" # IMAPS (SSL/TLS)
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
    depends_on:
      - identity
      - storage
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - imap_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${IMAP_REST_PORT:-9103}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  storage:
    build:
      context: .
      dockerfile: ./services/storage/Dockerfile
    image: ghcr.io/pavelperna/digidig-storage:latest
    restart: unless-stopped
    ports:
      - "${STORAGE_HTTP_PORT:-9102}:9102"   # HTTP
      - "${STORAGE_HTTPS_PORT:-9202}:9202"  # HTTPS
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - STORAGE_HTTP_PORT=9102
      - STORAGE_HTTPS_PORT=9202
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - storage_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${STORAGE_PORT:-9102}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  sso:
    build:
      context: .
      dockerfile: ./services/sso/Dockerfile
    image: ghcr.io/pavelperna/digidig-sso:latest
    restart: unless-stopped
    ports:
      - "${SSO_HTTP_PORT:-9106}:9106"   # HTTP
      - "${SSO_HTTPS_PORT:-9206}:9206"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - SSO_HTTP_PORT=9106
      - SSO_HTTPS_PORT=9206
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - sso_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests

  admin:
    build:
      context: .
      dockerfile: ./services/admin/Dockerfile
    image: ghcr.io/pavelperna/digidig-admin:latest
    restart: unless-stopped
    ports:
      - "${ADMIN_HTTP_PORT:-9105}:9105"      # HTTP
      - "${ADMIN_HTTPS_PORT:-9205}:9205"     # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - ADMIN_HTTP_PORT=9105
      - ADMIN_HTTPS_PORT=9205
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
    networks:
      - strategos-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker socket for restart functionality
      - ./:/app/project:ro  # Mount project root for docker-compose.yml access
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - admin_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:9105/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  client:
    build:
      context: .
      dockerfile: ./services/client/Dockerfile
    image: ghcr.io/pavelperna/digidig-client:latest
    restart: unless-stopped
    ports:
      - "${CLIENT_HTTP_PORT:-9104}:9104"   # HTTP
      - "${CLIENT_HTTPS_PORT:-9204}:9204"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - CLIENT_HTTP_PORT=9104
      - CLIENT_HTTPS_PORT=9204
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - client_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:9104/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  test-suite:
    build:
      context: .
      dockerfile: ./services/test-suite/Dockerfile
    image: ghcr.io/pavelperna/digidig-test-suite:latest
    restart: unless-stopped
    ports:
      - "${TEST_SUITE_HTTP_PORT:-9108}:9108"   # HTTP
      - "${TEST_SUITE_HTTPS_PORT:-9208}:9208"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - TEST_SUITE_HTTP_PORT=9108
      - TEST_SUITE_HTTPS_PORT=9208
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - test_suite_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${TEST_SUITE_PORT:-9108}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  mail:
    build:
      context: .
      dockerfile: ./services/mail/Dockerfile
    image: ghcr.io/pavelperna/digidig-mail:latest
    restart: unless-stopped
    ports:
      - "${MAIL_HTTP_PORT:-9107}:9107"   # HTTP
      - "${MAIL_HTTPS_PORT:-9207}:9207"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - MAIL_HTTP_PORT=9107
      - MAIL_HTTPS_PORT=9207
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
      - storage
      - smtp
      - imap
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - mail_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:9107/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  apidocs:
    build:
      context: .
      dockerfile: ./services/apidocs/Dockerfile
    image: ghcr.io/pavelperna/digidig-apidocs:latest
    restart: unless-stopped
    ports:
      - "${APIDOCS_HTTP_PORT:-9110}:9110"   # HTTP
      - "${APIDOCS_HTTPS_PORT:-9210}:9210"  # HTTPS
    environment:
      - DIGIDIG_ENV=${DIGIDIG_ENV:-dev}
      - APIDOCS_HTTP_PORT=9110
      - APIDOCS_HTTPS_PORT=9210
      - DIGIDIG_HOSTNAME=${HOSTNAME:-digidig.cz}
    depends_on:
      - identity
      - storage
      - smtp
      - imap
      - admin
      - mail
      - sso
    networks:
      - strategos-net
    volumes:
      - ./config:/app/config:ro
      - ./ssl:/app/ssl:ro
      - apidocs_data:/app/data
      - app_logs:/app/logs
      - test_data:/app/tests
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; resp = urllib.request.urlopen('http://localhost:${APIDOCS_PORT:-9110}/health', timeout=5); exit(0 if 200 <= resp.getcode() < 400 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

networks:
  strategos-net:
    driver: bridge

volumes:
  # Database volumes
  postgres_data:
    driver: local
  mongo_data:
    driver: local
  
  # Application data volumes
  identity_data:
    driver: local
  smtp_data:
    driver: local
  imap_data:
    driver: local
  storage_data:
    driver: local
  admin_data:
    driver: local
  client_data:
    driver: local
  test_suite_data:
    driver: local
  mail_data:
    driver: local
  sso_data:
    driver: local
  apidocs_data:
    driver: local
  
  # Shared volumes
  app_logs:
    driver: local
  test_data:
    driver: local

