<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/datagrid.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', path='css/password-validation.css') }}">
</head>
<body>
    <!-- Header section -->
    <div class="digidig-header">
        <div class="digidig-header-left">
            <h1>Admin Dashboard</h1>
        </div>
        <div class="digidig-header-right">
            <div class="digidig-language-selector">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="cs" selected>Čeština</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="digidig-avatar-wrapper">
                <button class="digidig-avatar-button" onclick="toggleAvatarDropdown()" aria-haspopup="true" aria-expanded="false">
                    <!-- simple avatar circle -->
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="8" r="3"></circle>
                        <path d="M21 21v-1a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v1"></path>
                    </svg>
                </button>
                <div id="avatarDropdown" class="digidig-avatar-dropdown hidden">
                    <button class="digidig-dropdown-item" onclick="doLogout()">Odhlásit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <!-- Left pane: menu -->
        <aside class="left-pane">
            <nav class="menu">
                <ul>
                    <li><button class="menu-item active" onclick="showDomains()">Domény</button></li>
                    <li><button class="menu-item" onclick="goToServices()">Služby</button></li>
                </ul>
            </nav>
        </aside>

        <!-- Right pane: content (domains/users/controls) -->
        <main class="right-pane">
        <!-- Domains Section -->
        <div class="section domains">
            <div class="header">
                <h2>Domény</h2>
                <button onclick="showDomainModal()" class="add-button">
                    <svg class="button-icon" viewBox="0 0 24 24">
                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                    </svg>
                    Přidat doménu
                </button>
            </div>
            <div class="datagrid">
                <table>
                    <thead>
                        <tr>
                            <th>Název domény</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for domain in domains %}
                        <tr>
                            <td>{{ domain.name }}</td>
                            <td class="actions">
                                <button onclick="showDomainModal('{{ domain.name }}')" class="edit-button">
                                    <svg class="button-icon" viewBox="0 0 24 24">
                                        <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                    </svg>
                                    Upravit
                                </button>
                                <button onclick="toggleUsers('{{ domain.name }}')" class="toggle-button">
                                    <svg class="button-icon" viewBox="0 0 24 24">
                                        <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                                    </svg>
                                    Uživatelé
                                </button>
                                <button onclick="deleteDomain('{{ domain.name }}')" class="delete-button">
                                    <svg class="button-icon" viewBox="0 0 24 24">
                                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                    Smazat
                                </button>
                            </td>
                        </tr>
                        <!-- Users for this domain -->
                        <tr class="users-row" id="users-{{ domain.name }}" style="display: none;">
                            <td colspan="2">
                                <div class="nested-grid">
                                    <div class="header">
                                        <h3>Uživatelé - {{ domain.name }}</h3>
                                        <button onclick="showUserModal(null, '{{ domain.name }}')" class="add-button">
                                            <svg class="button-icon" viewBox="0 0 24 24">
                                                <path d="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z"/>
                                            </svg>
                                            Přidat uživatele
                                        </button>
                                    </div>
                                    <table>
                                        <thead>
                                                <tr>
                                                    <th>Uživatel</th>
                                                    <th>Role</th>
                                                    <th>Akce</th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                                {% for user in users if user.domain == domain.name %}
                                                <tr data-user-id="{{ user.id }}">
                                                    <td>{{ user.username }}{% if user.domain %}@{{ user.domain }}{% endif %}</td>
                                                <td>{{ (user.roles | join(', ')) if user.roles else (user.role if user.role else '') }}</td>
                                                <td class="actions">
                                                        <button onclick="showUserModal('{{ user.username }}', '{{ domain.name }}', '{{ user.id }}')" class="edit-button">
                                                        <svg class="button-icon" viewBox="0 0 24 24">
                                                            <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                                        </svg>
                                                        Upravit
                                                    </button>
                                                    <button onclick="deleteUser('{{ user.id }}', '{{ user.username }}', '{{ user.domain }}')" class="delete-button">
                                                        <svg class="button-icon" viewBox="0 0 24 24">
                                                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                                        </svg>
                                                        Smazat
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </main>
    </div>

    <!-- Domain Modal -->
    <div id="domainModal" class="modal hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="domainModalTitle">Přidat doménu</h2>
            <form id="domainForm" onsubmit="handleDomainSubmit(event)">
                <input type="hidden" id="oldDomainName" name="oldName">
                <div class="form-group">
                    <label for="domainName">Název domény:</label>
                    <input type="text" id="domainName" name="name" required>
                </div>
                <button type="submit" class="submit-button">Uložit</button>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="userModalTitle">Přidat uživatele</h2>
            <form id="userForm" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="originalUsername" name="originalUsername">
                <input type="hidden" id="userId" name="id">
                <div class="form-group">
                    <label for="username">Uživatelské jméno:</label>
                    <div class="form-group email-group">
                        <input type="text" id="username" name="username" required pattern="[a-zA-Z0-9._-]+" title="Povolené znaky: písmena, čísla, tečka, pomlčka a podtržítko">
                        <input type="text" id="domain" name="domain" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole" name="role" required>
                        <option value="user">Uživatel</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPassword">Heslo:</label>
                        <div style="position:relative;display:flex;align-items:center;">
                            <input type="password" id="userPassword" name="password" 
                                   pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                   title="Heslo musí obsahovat alespoň 8 znaků, jedno velké písmeno, jedno malé písmeno, jednu číslici a jeden speciální znak (@$!%*?&)"
                                   style="flex:1;">
                            <span class="password-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a0a0a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </span>
                        </div>
                        <div class="password-requirements">
                            <h4>Požadavky na heslo:</h4>
                            <div class="password-policy-list">
                                <div class="policy-item" id="length-check">
                                    <span class="policy-label">Alespoň 8 znaků</span>
                                </div>
                                <div class="policy-item" id="uppercase-check">
                                    <span class="policy-label">Alespoň jedno velké písmeno</span>
                                </div>
                                <div class="policy-item" id="lowercase-check">
                                    <span class="policy-label">Alespoň jedno malé písmeno</span>
                                </div>
                                <div class="policy-item" id="number-check">
                                    <span class="policy-label">Alespoň jednu číslici</span>
                                </div>
                                <div class="policy-item" id="special-check">
                                    <span class="policy-label">Alespoň jeden speciální znak (@$!%*?&)</span>
                                </div>
                            </div>
                        </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Potvrzení hesla:</label>
                        <div style="position:relative;display:flex;align-items:center;">
                            <input type="password" id="confirmPassword" name="confirmPassword" style="flex:1;">
                            <span class="password-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a0a0a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </span>
                        </div>
                    <small class="password-match" style="display: none; color: #dc3545;">Hesla se neshodují</small>
                </div>
                <button type="submit" class="submit-button">Uložit</button>
            </form>
        </div>
    </div>

    <script>
        // Modal functionality
        const domainModal = document.getElementById('domainModal');
        const userModal = document.getElementById('userModal');
        const spans = document.getElementsByClassName('close');

        // Close modals when clicking (x)
        for (let span of spans) {
            span.onclick = function() {
                domainModal.style.display = "none";
                userModal.style.display = "none";
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target == domainModal) {
                domainModal.style.display = "none";
            }
            if (event.target == userModal) {
                userModal.style.display = "none";
            }
        }

        // Domain functions
        function showDomainModal(domainName = null) {
            const modal = document.getElementById('domainModal');
            const title = document.getElementById('domainModalTitle');
            const form = document.getElementById('domainForm');
            const nameInput = document.getElementById('domainName');
            const oldNameInput = document.getElementById('oldDomainName');

            if (domainName) {
                title.textContent = 'Upravit doménu';
                nameInput.value = domainName;
                oldNameInput.value = domainName;
            } else {
                title.textContent = 'Přidat doménu';
                nameInput.value = '';
                oldNameInput.value = '';
            }

            modal.style.display = "block";
        }

        async function handleDomainSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/manage-domain', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                location.reload();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }

        async function deleteDomain(name) {
            if (!confirm(`Opravdu chcete smazat doménu ${name}?`)) {
                return;
            }

            const formData = new FormData();
            formData.append('domain_name', name);

            try {
                const response = await fetch('/delete-domain', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                location.reload();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }

        // User functions
        function showUserModal(username = null, domain = null, id = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const originalUsernameInput = document.getElementById('originalUsername');
            const roleInput = document.getElementById('userRole');
            const passwordInput = document.getElementById('userPassword');

            if (username) {
                title.textContent = 'Upravit uživatele';
                const userDomain = domain;
                document.getElementById('username').value = username;
                document.getElementById('domain').value = userDomain ? userDomain : '';
                originalUsernameInput.value = username;
                if (id) {
                    document.getElementById('userId').value = id;
                } else {
                    document.getElementById('userId').value = '';
                }

                // Najdeme řádek s uživatelem podle zobrazeného jména (username[@domain]) a vyčteme roli
                const rows = Array.from(document.querySelectorAll('tr[data-user-id]'));
                const display = username + (userDomain ? `@${userDomain}` : '');
                const userRow = rows.find(row => {
                    const cell = row.querySelector('td');
                    return cell && cell.textContent.trim() === display;
                });
                if (userRow) {
                    const cells = userRow.querySelectorAll('td');
                    if (cells.length >= 2) {
                        // druhá buňka obsahuje text role
                        roleInput.value = cells[1].textContent.trim();
                    }
                }
                passwordInput.required = false;
                document.getElementById('confirmPassword').required = false;
                const requirements = document.querySelector('.password-requirements');
                if (requirements) {
                    requirements.style.display = 'none';
                }
            } else {
                title.textContent = 'Přidat uživatele';
                document.getElementById('username').value = '';
                document.getElementById('domain').value = domain;
                originalUsernameInput.value = '';
                document.getElementById('userId').value = '';
                roleInput.value = 'user';
                passwordInput.required = true;
                document.getElementById('confirmPassword').required = true;
                document.querySelector('.password-requirements').style.display = 'block';
            }
            
            // Reset password validation
            document.getElementById('userPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.querySelector('.password-match').style.display = 'none';
            document.querySelector('button[type="submit"]').disabled = false;
            document.querySelectorAll('.password-requirements li').forEach(li => {
                li.classList.remove('valid', 'invalid');
            });

            modal.style.display = "block";
        }

        function validatePassword(password) {
            const checks = {
                'length-check': password.length >= 8,
                'uppercase-check': /[A-Z]/.test(password),
                'lowercase-check': /[a-z]/.test(password),
                'number-check': /\d/.test(password),
                'special-check': /[@$!%*?&]/.test(password)
            };

            for (const [id, valid] of Object.entries(checks)) {
                const element = document.getElementById(id);
                element.classList.remove('valid', 'invalid');
                element.classList.add(valid ? 'valid' : 'invalid');
            }

            return Object.values(checks).every(v => v);
        }

        function checkPasswordMatch() {
            const password = document.getElementById('userPassword');
            const confirm = document.getElementById('confirmPassword');
            const matchMessage = document.querySelector('.password-match');
            const submitButton = document.querySelector('#userForm button[type="submit"]');

            if (password.value || confirm.value) {
                matchMessage.style.display = 'block';
                if (password.value === confirm.value && validatePassword(password.value)) {
                    matchMessage.style.display = 'none';
                    submitButton.disabled = false;
                    return true;
                } else {
                    matchMessage.style.color = '#dc3545';
                    matchMessage.textContent = 'Hesla se neshodují nebo nesplňují požadavky';
                    submitButton.disabled = true;
                    return false;
                }
            }
            return false;
        }

        // Password modal functions
        function showPasswordModal(username) {
            const modal = document.getElementById('passwordModal');
            const el = document.getElementById('passwordChangeUsername');
            if (el) el.value = username;
            modal.style.display = "block";
            
            // Reset form and validation
            document.getElementById('passwordForm').reset();
            document.querySelectorAll('.policy-item').forEach(item => {
                item.classList.remove('valid', 'invalid');
            });
            document.querySelector('.password-match').style.display = 'none';
        }

        async function handlePasswordSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            if (!validatePassword(formData.get('password'))) {
                alert('Heslo nesplňuje požadavky');
                return;
            }
            
            if (formData.get('password') !== formData.get('confirmPassword')) {
                alert('Hesla se neshodují');
                return;
            }

            try {
                const response = await fetch('/manage-user', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                document.getElementById('passwordModal').style.display = "none";
                location.reload();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }

        // Add password validation events for both modals
        ['userPassword', 'newPassword'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', function() {
                    validatePassword(this.value);
                    const confirmInput = this.id === 'userPassword' ? 'confirmPassword' : 'confirmNewPassword';
                    checkPasswordMatchFor(this.id, confirmInput);
                });
            }
        });

        ['confirmPassword', 'confirmNewPassword'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', function() {
                    const passwordInput = this.id === 'confirmPassword' ? 'userPassword' : 'newPassword';
                    checkPasswordMatchFor(passwordInput, this.id);
                });
            }
        });

        // Eye icon show/hide password (mousedown only)
        document.querySelectorAll('.password-eye').forEach(function(eye) {
            const input = eye.parentElement.querySelector('input');
            eye.addEventListener('mousedown', function() {
                input.type = 'text';
            });
            eye.addEventListener('mouseup', function() {
                input.type = 'password';
            });
            eye.addEventListener('mouseleave', function() {
                input.type = 'password';
            });
        });

        function checkPasswordMatchFor(passwordId, confirmId) {
            const password = document.getElementById(passwordId);
            const confirm = document.getElementById(confirmId);
            const matchMessage = confirm.parentElement.parentElement.querySelector('.password-match');
            
            if (password.value && confirm.value) {
                if (password.value !== confirm.value) {
                    matchMessage.style.display = 'block';
                    confirm.setCustomValidity('Hesla se neshodují');
                } else {
                    matchMessage.style.display = 'none';
                    confirm.setCustomValidity('');
                }
            } else {
                matchMessage.style.display = 'none';
                confirm.setCustomValidity('');
            }
        }

        async function handleUserSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const username = formData.get('username');
            const domain = document.getElementById('domain').value;
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');

            // Pokud je to nový uživatel nebo bylo zadáno heslo, validujeme ho
            const isNewUser = !formData.get('originalUsername');
            if (isNewUser || password) {
                if (!checkPasswordMatch()) {
                    alert('Prosím zadejte platné heslo a jeho potvrzení');
                    return;
                }
            }

            // Sestavení kompletního emailu
            // leave username and domain fields; server expects username and domain separately
            // vždy odstraň confirmPassword z odeslaných dat (server ho nepotřebuje)
            formData.delete('confirmPassword');

            // Pokud heslo není vyplněno (editace bez změny hesla), explicitně ho odstraň
            if (!password) {
                formData.delete('password');
            }

            // ensure domain doesn't include leading @
            const domainValue = document.getElementById('domain').value.replace(/^@/, '');
            formData.set('domain', domainValue);
            formData.set('username', username);

            // Ensure we don't send an empty id (backend expects integer when present)
            if (!formData.get('id')) {
                formData.delete('id');
            }

            // Debug: vypiš, co se bude odesílat -> zkontroluj v konzoli / Network
            const dump = {};
            for (const [k, v] of formData.entries()) dump[k] = v;
            console.debug('Submitting manage-user formData:', dump);

            // Uložení otevřené domény do localStorage
            const openDomain = domain.replace(/^@/, '');
            localStorage.setItem('openUsersDomain', openDomain);

            try {
                const response = await fetch('/manage-user', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                location.reload();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
        }

        async function deleteUser(id, username, domain) {
            const display = domain ? `${username}@${domain}` : username;
            if (!confirm(`Opravdu chcete smazat uživatele ${display}?`)) {
                return;
            }

            const formData = new FormData();
            // send explicit id field to backend
            formData.append('id', String(id));

            // Uložení otevřené domény do localStorage
            if (domain) localStorage.setItem('openUsersDomain', domain);
            try {
                const response = await fetch('/delete-user', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                location.reload();
            } catch (error) {
                alert('Chyba: ' + error.message);
            }
            // page will reload; the open domain will be restored on load
        }

        // Toggle users section
        function toggleUsers(domainName) {
            const usersRow = document.getElementById(`users-${domainName}`);
            const displayStyle = usersRow.style.display;
            const newDisplay = displayStyle === "none" ? "table-row" : "none";
            usersRow.style.display = newDisplay;
            // persist opened domain so reload keeps it expanded
            if (newDisplay === 'table-row') {
                localStorage.setItem('openUsersDomain', domainName);
            } else {
                // if collapsing, clear saved domain only if it matches
                const saved = localStorage.getItem('openUsersDomain');
                if (saved === domainName) localStorage.removeItem('openUsersDomain');
            }
        }
    </script>

    <script>
        // Restore the last opened users list after page load
        // Avatar dropdown toggle and logout
        function toggleAvatarDropdown() {
            const btn = document.querySelector('.digidig-avatar-button');
            const dd = document.getElementById('avatarDropdown');
            if (!btn || !dd) return;
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', String(!expanded));
            if (dd.classList.contains('hidden')) {
                dd.classList.remove('hidden');
            } else {
                dd.classList.add('hidden');
            }
        }

        async function doLogout() {
            // Call server-side logout to clear any cookie/session, then clear local UI state and redirect.
            try {
                await fetch('/logout', { method: 'POST', credentials: 'same-origin' });
            } catch (e) {
                // ignore network errors, still proceed with client-side cleanup
            }
            try {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('openUsersDomain');
            } catch (e) {
                // ignore
            }
            // Redirect to empty root endpoint instead of explicit login page
            window.location.href = '/';
        }

        function goToServices() {
            window.location.href = '/services?token={{ token }}';
        }

        // Close avatar dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('.digidig-avatar-wrapper');
            const dd = document.getElementById('avatarDropdown');
            const btn = document.querySelector('.digidig-avatar-button');
            if (!wrapper || !dd || !btn) return;
            if (!wrapper.contains(e.target)) {
                if (!dd.classList.contains('hidden')) {
                    dd.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                }
            }
        });

        (function restoreOpenUsers() {
            try {
                const openDomain = localStorage.getItem('openUsersDomain');
                if (openDomain) {
                    const usersRow = document.getElementById(`users-${openDomain}`);
                    if (usersRow) {
                        usersRow.style.display = 'table-row';
                    }
                }
            } catch (e) {
                // ignore
            }
        })();

        async function changeLanguage(lang) {
            try {
                await fetch('/api/language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language: lang })
                });
                window.location.reload();
            } catch (error) {
                console.error('Language change error:', error);
            }
        }
    </script>

    <!-- Password Change Modal -->
    <div id="passwordModal" class="modal hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Změna hesla</h2>
            <form id="passwordForm" onsubmit="handlePasswordSubmit(event)">
                
                <input type="hidden" id="passwordChangeUsername" name="username">
                <div class="form-group">
                    <label for="newPassword">Nové heslo:</label>
                    <div style="position:relative;display:flex;align-items:center;">
                        <input type="password" id="newPassword" name="password" 
                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                               title="Heslo musí obsahovat alespoň 8 znaků, jedno velké písmeno, jedno malé písmeno, jednu číslici a jeden speciální znak (@$!%*?&)"
                               style="flex:1;" required>
                        <span class="password-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a0a0a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </span>
                    </div>
                    <div class="password-requirements">
                        <h4>Požadavky na heslo:</h4>
                        <div class="password-policy-list">
                            <div class="policy-item" id="length-check">
                                <span class="policy-label">Alespoň 8 znaků</span>
                            </div>
                            <div class="policy-item" id="uppercase-check">
                                <span class="policy-label">Alespoň jedno velké písmeno</span>
                            </div>
                            <div class="policy-item" id="lowercase-check">
                                <span class="policy-label">Alespoň jedno malé písmeno</span>
                            </div>
                            <div class="policy-item" id="number-check">
                                <span class="policy-label">Alespoň jednu číslici</span>
                            </div>
                            <div class="policy-item" id="special-check">
                                <span class="policy-label">Alespoň jeden speciální znak (@$!%*?&)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Potvrzení hesla:</label>
                    <div style="position:relative;display:flex;align-items:center;">
                        <input type="password" id="confirmNewPassword" name="confirmPassword" style="flex:1;" required>
                        <span class="password-eye" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a0a0a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </span>
                    </div>
                    <small class="password-match" style="display: none; color: #dc3545;">Hesla se neshodují</small>
                </div>
                <button type="submit" class="submit-button">Uložit heslo</button>
            </form>
        </div>
    </div>
</body>
</html>
