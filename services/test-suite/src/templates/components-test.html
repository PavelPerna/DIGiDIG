<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations.title }} - {{ admin_email }}</title>

    <!-- DIGiDIG shared styles -->
    <link rel="stylesheet" href="/lib/common/components/top-pane/top-pane.css">
    <link rel="stylesheet" href="/lib/common/components/language-selector/language-selector.css">
    <link rel="stylesheet" href="/lib/common/components/dark-mode-switch/dark-mode-switch.css">
    <link rel="stylesheet" href="/lib/common/components/avatar-dropdown/avatar-dropdown.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color, #f5f5f5);
            color: var(--text-color, #333);
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            margin-top: 0;
            color: #2563eb;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .component-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            background: #f9fafb;
        }

        .component-item h3 {
            margin-top: 0;
            color: #374151;
            font-size: 1.1em;
        }

        .component-demo {
            margin: 10px 0;
            padding: 10px;
            border: 1px dashed #d1d5db;
            border-radius: 4px;
            background: white;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }

        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
        }

        .test-results pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .dark-mode {
            --bg-color: #1f2937;
            --text-color: #f9fafb;
        }

        .dark-mode .test-section,
        .dark-mode .test-header {
            background: #374151;
            color: #f9fafb;
        }

        .dark-mode .component-item {
            background: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .component-demo {
            background: #374151;
            border-color: #6b7280;
        }
    </style>
    <script>
        window.translations = {{ translations | tojson }};
        window.identity_url = '{{ identity_url }}';
    </script>
</head>
<body>
    <!-- DIGiDIG Top Pane Component -->
    <header class="digidig-top-pane" data-digidig-component="top-pane">
        <div class="digidig-top-pane-content">
            <div class="digidig-top-pane-left">
                <div class="digidig-top-pane-logo">
                    <a href="/" class="digidig-logo-link">
                        <svg class="digidig-logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6"/>
                            <path d="m21 12-6-3-6 3-6-3"/>
                        </svg>
                        <span class="digidig-logo-text">DIGiDIG</span>
                    </a>
                </div>
            </div>
            <div class="digidig-top-pane-center">
                <h1 class="digidig-top-pane-title">Components Test</h1>
            </div>
            <div class="digidig-top-pane-right">
                <div class="digidig-top-pane-user-controls">
                    <div class="digidig-avatar-dropdown" data-digidig-component="avatar-dropdown"></div>
                </div>
            </div>
        </div>
    </header>

    <div class="test-container">
        <div class="test-header">
                        <h1>{{ translations.title }}</h1>
            <p>{{ translations.subtitle }} with {{ translations.authenticated_user }}: <strong>{{ admin_email }}</strong></p>
            <div id="auth-status">
                <span class="status-indicator status-warning"></span>
                {{ translations.checking_auth }}
            </div>
        </div>

        <div class="test-section">
            <h2>{{ translations.component_status }}</h2>
            <div class="component-grid">
                <div class="component-item">
                    <h3>ðŸ”¤ {{ translations.language_selector }}</h3>
                    <div class="component-demo">
                        <div data-digidig-component="language-selector"></div>
                    </div>
                    <div id="lang-status">
                        <span class="status-indicator status-warning"></span>
                        {{ translations.initializing }}
                    </div>
                </div>

                <div class="component-item">
                    <h3>ðŸŒ™ {{ translations.dark_mode_switch }}</h3>
                    <div class="component-demo">
                        <div data-digidig-component="dark-mode-switch"></div>
                    </div>
                    <div id="theme-status">
                        <span class="status-indicator status-warning"></span>
                        {{ translations.initializing }}
                    </div>
                </div>

                <div class="component-item">
                    <h3>ðŸ‘¤ {{ translations.avatar_dropdown }}</h3>
                    <div class="component-demo">
                        <div data-digidig-component="avatar-dropdown"></div>
                    </div>
                    <div id="avatar-status">
                        <span class="status-indicator status-warning"></span>
                        {{ translations.initializing }}
                    </div>
                </div>

                <div class="component-item">
                    <h3>ðŸ“Š {{ translations.top_pane }}</h3>
                    <div class="component-demo">
                        <p>Top pane is rendered above this content</p>
                    </div>
                    <div id="top-pane-status">
                        <span class="status-indicator status-warning"></span>
                        {{ translations.initializing }}
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>{{ translations.user_preferences }}</h2>
            <div id="preferences-display">
                <span class="status-indicator status-warning"></span>
                {{ translations.loading_prefs }}
            </div>
        </div>

        <div class="test-section">
            <h2>{{ translations.test_results }}</h2>
            <div class="test-results">
                <pre id="test-output">{{ translations.starting_tests }}</pre>
            </div>
        </div>
    </div>

    <!-- DIGiDIG Reusable Components Scripts -->
    <script src="/lib/common/components/shared/preferences-manager.js"></script>
    <script src="/lib/common/components/shared/utils.js"></script>
    <script src="/lib/common/components/language-selector/language-selector.js"></script>
    <script src="/lib/common/components/dark-mode-switch/dark-mode-switch.js"></script>
    <script src="/lib/common/components/avatar-dropdown/avatar-dropdown.js"></script>
    <script src="/lib/common/components/top-pane/top-pane.js"></script>

    <script>
        // Test suite for DIGiDIG components
        class ComponentTestSuite {
            constructor() {
                this.results = [];
                this.components = {};
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
                this.results.push(logEntry);
                this.updateOutput();
                console[type](message);
            }

            updateOutput() {
                const output = document.getElementById('test-output');
                if (output) {
                    output.textContent = this.results.join('\n');
                    output.scrollTop = output.scrollHeight;
                }
            }

            updateStatus(elementId, status, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    const indicator = element.querySelector('.status-indicator');
                    if (indicator) {
                        indicator.className = `status-indicator status-${status}`;
                    }
                    element.innerHTML = element.innerHTML.replace(/Initializing\.\.\.|Loading preferences\.\.\.|Checking authentication\.\.\./, message);
                }
            }

            async checkAuthentication() {
                // Authentication is now handled server-side
                // Since we reached this page, the user is already authenticated
                this.log('Authentication successful (server-side check passed)');
                this.updateStatus('auth-status', 'success', 'Authenticated');
                return true;
            }



            

            async checkPreferences() {
                try {
                    const prefs = await window.DigiDigPreferences.getPreferences();
                    this.log(`Preferences loaded: language=${prefs.language}, darkMode=${prefs.darkMode}`);
                    this.updateStatus('preferences-display', 'success',
                        `Language: ${prefs.language}, Dark Mode: ${prefs.darkMode}`);
                    return prefs;
                } catch (error) {
                    this.log(`Preferences load error: ${error}`, 'error');
                    this.updateStatus('preferences-display', 'error', 'Failed to load preferences');
                    return null;
                }
            }

            async testLanguageSelector() {
                try {
                    const element = document.querySelector('[data-digidig-component="language-selector"]');
                    if (!element) {
                        throw new Error('Language selector element not found');
                    }

                    // Check if component has a select element (indicates it's rendered)
                    const select = element.querySelector('select');
                    if (!select) {
                        throw new Error('Language selector select element not found');
                    }

                    this.components.languageSelector = element;
                    this.log('Language selector initialized successfully');
                    this.updateStatus('lang-status', 'success', 'Initialized');

                    // Test language change by triggering the select change
                    const currentValue = select.value;
                    const testValue = currentValue === 'cs' ? 'en' : 'cs';
                    select.value = testValue;
                    select.dispatchEvent(new Event('change'));
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const newLang = await window.DigiDigPreferences.getPreference('language');
                    if (newLang === testValue) {
                        this.log('Language selector change test passed');
                    } else {
                        this.log(`Language selector change test failed: expected ${testValue}, got ${newLang}`, 'warn');
                    }

                } catch (error) {
                    this.log(`Language selector test failed: ${error}`, 'error');
                    this.updateStatus('lang-status', 'error', 'Failed');
                }
            }

            async testDarkModeSwitch() {
                try {
                    const element = document.querySelector('[data-digidig-component="dark-mode-switch"]');
                    if (!element) {
                        throw new Error('Dark mode switch element not found');
                    }

                    // Wait for component initialization
                    await new Promise(resolve => {
                        const checkInit = () => {
                            if (element._digidigComponent) {
                                resolve();
                            } else {
                                setTimeout(checkInit, 100);
                            }
                        };
                        checkInit();
                    });

                    this.components.darkModeSwitch = element._digidigComponent;
                    this.log('Dark mode switch initialized successfully');
                    this.updateStatus('theme-status', 'success', 'Initialized');

                    // Test theme toggle
                    const initialDark = await window.DigiDigPreferences.getPreference('darkMode');
                    element._digidigComponent.setDarkMode(!initialDark);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const newDark = await window.DigiDigPreferences.getPreference('darkMode');
                    if (newDark !== initialDark) {
                        this.log('Dark mode switch toggle test passed');
                        if (newDark) {
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                        }
                    } else {
                        this.log('Dark mode switch toggle test failed', 'warn');
                    }

                } catch (error) {
                    this.log(`Dark mode switch test failed: ${error}`, 'error');
                    this.updateStatus('theme-status', 'error', 'Failed');
                }
            }

            async testAvatarDropdown() {
                try {
                    const elements = document.querySelectorAll('[data-digidig-component="avatar-dropdown"]');
                    if (elements.length === 0) {
                        throw new Error('Avatar dropdown elements not found');
                    }

                    // Test the main one (in top pane)
                    const element = elements[0];

                    // Wait for component initialization
                    await new Promise(resolve => {
                        const checkInit = () => {
                            if (element._digidigComponent) {
                                resolve();
                            } else {
                                setTimeout(checkInit, 100);
                            }
                        };
                        checkInit();
                    });

                    this.components.avatarDropdown = element._digidigComponent;
                    this.log('Avatar dropdown initialized successfully');
                    this.updateStatus('avatar-status', 'success', 'Initialized');

                    // Test user info loading
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const button = element.querySelector('.digidig-avatar-button');
                    const nameElement = element.querySelector('.digidig-avatar-name');

                    if (nameElement && nameElement.textContent !== 'User') {
                        this.log('Avatar dropdown user info loaded successfully');
                    } else {
                        this.log('Avatar dropdown user info not loaded', 'warn');
                    }

                } catch (error) {
                    this.log(`Avatar dropdown test failed: ${error}`, 'error');
                    this.updateStatus('avatar-status', 'error', 'Failed');
                }
            }

            async testTopPane() {
                try {
                    const element = document.querySelector('[data-digidig-component="top-pane"]');
                    if (!element) {
                        throw new Error('Top pane element not found');
                    }

                    // Wait for component initialization
                    await new Promise(resolve => {
                        const checkInit = () => {
                            if (element._digidigComponent) {
                                resolve();
                            } else {
                                setTimeout(checkInit, 100);
                            }
                        };
                        checkInit();
                    });

                    this.components.topPane = element._digidigComponent;
                    this.log('Top pane initialized successfully');
                    this.updateStatus('top-pane-status', 'success', 'Initialized');

                } catch (error) {
                    this.log(`Top pane test failed: ${error}`, 'error');
                    this.updateStatus('top-pane-status', 'error', 'Failed');
                }
            }

            async runAllTests() {
                this.log('Starting DIGiDIG Components Test Suite');

                // Check authentication first
                const isAuthenticated = await this.checkAuthentication();
                if (!isAuthenticated) {
                    this.log('Cannot proceed with tests - authentication failed', 'error');
                    return;
                }

                // Load preferences
                await this.checkPreferences();

                // Test individual components
                await Promise.all([
                    this.testLanguageSelector(),
                    this.testDarkModeSwitch(),
                    this.testAvatarDropdown(),
                    this.testTopPane()
                ]);

                this.log('Component tests completed');
            }
        }

        // Initialize test suite when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const testSuite = new ComponentTestSuite();

            // Authentication is handled by redirecting to SSO if needed
            // Run tests after DigiDig components are initialized
            setTimeout(async () => {
                await testSuite.runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>