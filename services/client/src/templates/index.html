<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Dashboard - DIGiDIG</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- DIGiDIG Reusable Components -->
    <link rel="stylesheet" href="/lib/common/components/language-selector/language-selector.css">
    <link rel="stylesheet" href="/lib/common/components/dark-mode-switch/dark-mode-switch.css">
    <link rel="stylesheet" href="/lib/common/components/avatar-dropdown/avatar-dropdown.css">
    <link rel="stylesheet" href="/lib/common/components/top-pane/top-pane.css">
</head>
<body>
    <!-- DIGiDIG Top Pane Component -->
    <header class="digidig-top-pane" data-digidig-component="top-pane">
        <div class="digidig-top-pane-content">
            <!-- Left section - Logo and navigation -->
            <div class="digidig-top-pane-left">
                <div class="digidig-top-pane-logo">
                    <a href="/" class="digidig-logo-link" aria-label="Go to homepage">
                        <svg class="digidig-logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6"/>
                            <path d="m21 12-6-3-6 3-6-3"/>
                        </svg>
                        <span class="digidig-logo-text">DIGiDIG</span>
                    </a>
                </div>
            </div>

            <!-- Center section - Welcome message -->
            <div class="digidig-top-pane-center">
                <h1 class="digidig-top-pane-title" id="welcomeMsg">Welcome, {{ username }}!</h1>
            </div>

            <!-- Right section - User controls -->
            <div class="digidig-top-pane-right">
                <!-- Authenticated user controls -->
                <div class="digidig-top-pane-user-controls" data-auth-required="true">
                    <!-- Avatar dropdown component -->
                    <div class="digidig-avatar-dropdown" data-digidig-component="avatar-dropdown">
                        <!-- Avatar trigger button -->
                        <button class="digidig-avatar-button" type="button" aria-haspopup="true" aria-expanded="false" aria-label="User menu">
                            <div class="digidig-avatar-image">
                                <svg class="digidig-avatar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                            <span class="digidig-avatar-name">{{ username }}</span>
                            <svg class="digidig-avatar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6,9 12,15 18,9"/>
                            </svg>
                        </button>

                        <!-- Dropdown menu -->
                        <div class="digidig-avatar-menu" role="menu" aria-hidden="true">
                            <div class="digidig-avatar-menu-content">
                                <!-- User info section -->
                                <div class="digidig-avatar-user-info">
                                    <div class="digidig-avatar-user-avatar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                        </svg>
                                    </div>
                                    <div class="digidig-avatar-user-details">
                                        <div class="digidig-avatar-user-name">{{ username }}</div>
                                        <div class="digidig-avatar-user-email">user@digidig.com</div>
                                    </div>
                                </div>

                                <!-- Divider -->
                                <div class="digidig-avatar-menu-divider"></div>

                                <!-- Preferences section -->
                                <div class="digidig-avatar-preferences">
                                    <div class="digidig-avatar-preference-group">
                                        <label class="digidig-avatar-preference-label">Language</label>
                                        <div class="digidig-avatar-preference-control" data-digidig-component="language-selector">
                                            <select class="digidig-language-select" aria-label="Select language">
                                                <option value="en">English</option>
                                                <option value="cs">Čeština</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="digidig-avatar-preference-group">
                                        <div class="digidig-avatar-preference-control" data-digidig-component="dark-mode-switch">
                                            <label class="digidig-switch-wrapper">
                                                <input type="checkbox" class="digidig-switch-input" aria-label="Toggle dark mode">
                                                <span class="digidig-switch-slider">
                                                    <span class="digidig-switch-handle">
                                                        <!-- Light mode icon -->
                                                        <svg class="digidig-switch-icon digidig-switch-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <circle cx="12" cy="12" r="5"/>
                                                            <line x1="12" y1="1" x2="12" y2="3"/>
                                                            <line x1="12" y1="21" x2="12" y2="23"/>
                                                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                                            <line x1="1" y1="12" x2="3" y2="12"/>
                                                            <line x1="21" y1="12" x2="23" y2="12"/>
                                                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                                        </svg>
                                                        <!-- Dark mode icon -->
                                                        <svg class="digidig-switch-icon digidig-switch-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                                        </svg>
                                                    </span>
                                                </span>
                                                <span class="digidig-switch-label">Dark Mode</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Divider -->
                                <div class="digidig-avatar-menu-divider"></div>

                                <!-- Actions section -->
                                <div class="digidig-avatar-actions">
                                    <a href="/logout" class="digidig-avatar-action-link" role="menuitem">
                                        <svg class="digidig-avatar-action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                            <polyline points="16,17 21,12 16,7"/>
                                            <line x1="21" y1="12" x2="9" y2="12"/>
                                        </svg>
                                        <span id="logoutBtn">Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Backdrop for closing dropdown -->
                        <div class="digidig-avatar-backdrop" aria-hidden="true"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        {% if message %}
            <div class="message">{{ message }}</div>
        {% endif %}
        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        <div class="compose-section">
            <h2 id="composeTitle">Compose Email</h2>
            <form action="/send" method="post">
                <div class="form-group">
                    <label for="recipient" id="labelRecipient">Recipient</label>
                    <input type="email" id="recipient" name="recipient" required>
                </div>
                <div class="form-group">
                    <label for="subject" id="labelSubject">Subject</label>
                    <input type="text" id="subject" name="subject" required>
                </div>
                <div class="form-group">
                    <label for="body" id="labelMessage">Message</label>
                    <textarea id="body" name="body" required></textarea>
                </div>
                <button type="submit" class="send-btn" id="sendBtn">Send Email</button>
            </form>
        </div>

        <div class="emails-section">
            <h2 id="inboxTitle">Your Emails</h2>
            {% if emails %}
                {% for email in emails %}
                    <div class="email-item">
                        <div>
                            <strong id="emailFrom">From:</strong> {{ email.sender }}
                        </div>
                        <div>
                            <strong id="emailSubject">Subject:</strong> {{ email.subject }}
                        </div>
                        {% if email.timestamp %}
                            <div class="timestamp">{{ email.timestamp }}</div>
                        {% endif %}
                        <div class="email-body">{{ email.body }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-emails">
                    <p id="noEmails">You have no emails yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- DIGiDIG Reusable Components Scripts -->
    <script src="/lib/common/components/shared/preferences-manager.js"></script>
    <script src="/lib/common/components/shared/utils.js"></script>
    <script src="/lib/common/components/language-selector/language-selector.js"></script>
    <script src="/lib/common/components/dark-mode-switch/dark-mode-switch.js"></script>
    <script src="/lib/common/components/avatar-dropdown/avatar-dropdown.js"></script>
    <script src="/lib/common/components/top-pane/top-pane.js"></script>

    <!-- Fallback: Ensure avatar-dropdown is initialized if not handled by top-pane -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-digidig-component="avatar-dropdown"]').forEach(element => {
                if (!element._digidigComponent && window.DigiDigAvatarDropdown) {
                    try {
                        window.DigiDigUtils.Component.createComponent(window.DigiDigAvatarDropdown, element);
                    } catch (error) {
                        console.error('Failed to fallback-initialize avatar dropdown:', error);
                    }
                }
                // Safe fallback: ensure button toggles the menu even if component failed
                try {
                    const btn = element.querySelector('.digidig-avatar-button');
                    const menu = element.querySelector('.digidig-avatar-menu');
                    const backdrop = element.querySelector('.digidig-avatar-backdrop') || document.createElement('div');
                    if (backdrop && !backdrop.parentElement) {
                        // ensure backdrop exists in DOM for closing
                        backdrop.className = 'digidig-avatar-backdrop';
                        backdrop.setAttribute('aria-hidden', 'true');
                        document.body.appendChild(backdrop);
                    }
                    if (btn && menu) {
                        // attach non-destructive toggle handler if none present
                        const existing = btn.getAttribute('data-digidig-fallback');
                        if (!existing) {
                            btn.setAttribute('data-digidig-fallback', 'true');
                            btn.addEventListener('click', (ev) => {
                                ev.preventDefault();
                                const isHidden = menu.getAttribute('aria-hidden') !== 'false';
                                menu.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
                                btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                                element.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                                if (!isHidden) {
                                    backdrop.setAttribute('aria-hidden', 'true');
                                } else {
                                    backdrop.setAttribute('aria-hidden', 'false');
                                }
                            });
                            // backdrop click closes menu
                            backdrop.addEventListener('click', () => {
                                menu.setAttribute('aria-hidden', 'true');
                                btn.setAttribute('aria-expanded', 'false');
                                element.setAttribute('aria-expanded', 'false');
                                backdrop.setAttribute('aria-hidden', 'true');
                            });
                        }
                    }
                } catch (e) {
                    console.warn('avatar-dropdown fallback attach error', e);
                }
            });
        });
    </script>

    <script>
        // Translations for the client interface
        const translations = {
            en: {
                pageTitle: 'Dashboard - DIGiDIG',
                welcomeMsg: 'Welcome, {{ username }}!',
                logoutBtn: 'Logout',
                composeTitle: 'Compose Email',
                labelRecipient: 'Recipient',
                labelSubject: 'Subject',
                labelMessage: 'Message',
                sendBtn: 'Send Email',
                inboxTitle: 'Your Emails',
                emailFrom: 'From:',
                emailSubject: 'Subject:',
                noEmails: 'You have no emails yet.'
            },
            cs: {
                pageTitle: 'Nástěnka - DIGiDIG',
                welcomeMsg: 'Vítejte, {{ username }}!',
                logoutBtn: 'Odhlásit se',
                composeTitle: 'Napsat email',
                labelRecipient: 'Příjemce',
                labelSubject: 'Předmět',
                labelMessage: 'Zpráva',
                sendBtn: 'Odeslat email',
                inboxTitle: 'Vaše emaily',
                emailFrom: 'Od:',
                emailSubject: 'Předmět:',
                noEmails: 'Zatím nemáte žádné emaily.'
            }
        };

        // Update UI texts based on language
        function updateUI(lang) {
            const t = translations[lang] || translations.en;
            const username = '{{ username }}';
            
            document.title = t.pageTitle;
            document.getElementById('welcomeMsg').textContent = t.welcomeMsg.replace('{{ username }}', username);
            document.getElementById('logoutBtn').textContent = t.logoutBtn;
            document.getElementById('composeTitle').textContent = t.composeTitle;
            document.getElementById('labelRecipient').textContent = t.labelRecipient;
            document.getElementById('labelSubject').textContent = t.labelSubject;
            document.getElementById('labelMessage').textContent = t.labelMessage;
            document.getElementById('sendBtn').textContent = t.sendBtn;
            document.getElementById('inboxTitle').textContent = t.inboxTitle;
            
            // Update email labels if they exist
            const emailFromLabels = document.querySelectorAll('#emailFrom');
            emailFromLabels.forEach(el => el.textContent = t.emailFrom);
            
            const emailSubjectLabels = document.querySelectorAll('#emailSubject');
            emailSubjectLabels.forEach(el => el.textContent = t.emailSubject);
            
            const noEmailsEl = document.getElementById('noEmails');
            if (noEmailsEl) {
                noEmailsEl.textContent = t.noEmails;
            }
        }

        // Initialize the client interface
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize top pane with client-specific options
            const topPaneElement = document.querySelector('[data-digidig-component="top-pane"]');
            if (topPaneElement && window.DigiDigTopPane) {
                const topPane = new window.DigiDigTopPane(topPaneElement, {
                    title: null, // We use welcome message instead
                    logoText: 'DIGiDIG',
                    logoUrl: '/',
                    userInfoEndpoint: '{{ identity_url }}/api/user/info',
                    logoutUrl: '/api/identity/logout',
                    responsive: true
                });

                // Listen for language changes from components
                topPaneElement.addEventListener('digidig:top-pane:language-change', (event) => {
                    updateUI(event.detail.language);
                });

                // Listen for theme changes from components
                topPaneElement.addEventListener('digidig:top-pane:theme-change', (event) => {
                    // Theme is automatically applied by the dark mode switch component
                    console.log('Theme changed to:', event.detail.theme);
                });

                // Listen for auth state changes
                topPaneElement.addEventListener('digidig:top-pane:auth-state-change', (event) => {
                    console.log('Auth state changed to:', event.detail.authState);
                });
            }

            // Load current language and update UI
            if (window.DigiDigPreferences) {
                window.DigiDigPreferences.getPreference('language').then(lang => {
                    updateUI(lang || 'en');
                }).catch(error => {
                    console.warn('Failed to load language preference:', error);
                    updateUI('en');
                });
            } else {
                updateUI('en');
            }
        });
    </script>
</body>
</html>